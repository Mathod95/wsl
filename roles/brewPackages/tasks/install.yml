---
#- name: Disable Homebrew analytics
#  ansible.builtin.command:
#    cmd: /home/linuxbrew/.linuxbrew/bin/brew analytics off
#  register: brew_analytics_result
#  changed_when: false

- name: Install item via Homebrew
  community.general.homebrew:
    name: "{{ item }}"
    state: present
  loop:
    - ansible
    - argocd
    - argocd-autopilot
    #- asciinema
    #- awscli
    - bat
    - btop
    #- cilium-cli
    #- cloud-provider-kind
    #- crossplane
    - curl
    #- docker
    - eza
    - fastfetch
    - fd
    - fzf
    - git
    - helm
    #- k9s
    #- keychain
    - kind
    #- kube-linter
    #- kube-score
    - kubecolor
    - kubectl
    #- kubescape
    - kubectx
    #- krew
    - kustomize
    - kyverno
    #- neovim
    #- opentofu
    - ripgrep
    - systemd
    #- velero
    - vim
    - wget
    - zellij
    - zinit
    - zsh

- name: Get list of installed Homebrew packages with versions
  ansible.builtin.command: brew list --versions
  register: brew_versions
  changed_when: false
  ignore_errors: yes
  tags:
    - versions

- name: Parse Homebrew versions for each tool
  set_fact:
    ansible_version: "{{ brew_versions.stdout_lines | select('search', '^ansible ') | first | regex_replace('ansible\\s+', '') | default('âŒ non installÃ©') }}"
    argocd_version: "{{ brew_versions.stdout_lines | select('search', '^argocd ') | first | regex_replace('argocd\\s+', '') | default('âŒ non installÃ©') }}"
    awscli_version: "{{ brew_versions.stdout_lines | select('search', '^awscli ') | first | regex_replace('awscli\\s+', '') | default('âŒ non installÃ©') }}"
    bat_version: "{{ brew_versions.stdout_lines | select('search', '^bat ') | first | regex_replace('bat\\s+', '') | default('âŒ non installÃ©') }}"
    btop_version: "{{ brew_versions.stdout_lines | select('search', '^btop ') | first | regex_replace('btop\\s+', '') | default('âŒ non installÃ©') }}"
    cilium_version: "{{ brew_versions.stdout_lines | select('search', '^cilium-cli ') | first | regex_replace('cilium-cli\\s+', '') | default('âŒ non installÃ©') }}"
    crossplane_version: "{{ brew_versions.stdout_lines | select('search', '^crossplane ') | first | regex_replace('crossplane\\s+', '') | default('âŒ non installÃ©') }}"
    curl_version: "{{ brew_versions.stdout_lines | select('search', '^curl ') | first | regex_replace('curl\\s+', '') | default('âŒ non installÃ©') }}"
    docker_version: "{{ brew_versions.stdout_lines | select('search', '^docker ') | first | regex_replace('docker\\s+', '') | default('âŒ non installÃ©') }}"
    eza_version: "{{ brew_versions.stdout_lines | select('search', '^eza ') | first | regex_replace('eza\\s+', '') | default('âŒ non installÃ©') }}"
    fd_version: "{{ brew_versions.stdout_lines | select('search', '^fd ') | first | regex_replace('fd\\s+', '') | default('âŒ non installÃ©') }}"
    fzf_version: "{{ brew_versions.stdout_lines | select('search', '^fzf ') | first | regex_replace('fzf\\s+', '') | default('âŒ non installÃ©') }}"
    git_version: "{{ brew_versions.stdout_lines | select('search', '^git ') | first | regex_replace('git\\s+', '') | default('âŒ non installÃ©') }}"
    helm_version: "{{ brew_versions.stdout_lines | select('search', '^helm ') | first | regex_replace('helm\\s+', '') | default('âŒ non installÃ©') }}"
    k9s_version: "{{ brew_versions.stdout_lines | select('search', '^k9s ') | first | regex_replace('k9s\\s+', '') | default('âŒ non installÃ©') }}"
    keychain_version: "{{ brew_versions.stdout_lines | select('search', '^keychain ') | first | regex_replace('keychain\\s+', '') | default('âŒ non installÃ©') }}"
    kind_version: "{{ brew_versions.stdout_lines | select('search', '^kind ') | first | regex_replace('kind\\s+', '') | default('âŒ non installÃ©') }}"
    krew_version: "{{ brew_versions.stdout_lines | select('search', '^krew ') | first | regex_replace('krew\\s+', '') | default('âŒ non installÃ©') }}"
    kube_score_version: "{{ brew_versions.stdout_lines | select('search', '^kube-score ') | first | regex_replace('kube-score\\s+', '') | default('âŒ non installÃ©') }}"
    kubecolor_version: "{{ brew_versions.stdout_lines | select('search', '^kubecolor ') | first | regex_replace('kubecolor\\s+', '') | default('âŒ non installÃ©') }}"
    kubectl_version: "{{ brew_versions.stdout_lines | select('search', '^kubernetes-cli ') | first | regex_replace('kubernetes-cli\\s+', '') | default('âŒ non installÃ©') }}"
    kubectx_version: "{{ brew_versions.stdout_lines | select('search', '^kubectx ') | first | regex_replace('kubectx\\s+', '') | default('âŒ non installÃ©') }}"
    kustomize_version: "{{ brew_versions.stdout_lines | select('search', '^kustomize ') | first | regex_replace('kustomize\\s+', '') | default('âŒ non installÃ©') }}"
    kyverno_version: "{{ brew_versions.stdout_lines | select('search', '^kyverno ') | first | regex_replace('kyverno\\s+', '') | default('âŒ non installÃ©') }}"
    neovim_version: "{{ brew_versions.stdout_lines | select('search', '^neovim ') | first | regex_replace('neovim\\s+', '') | default('âŒ non installÃ©') }}"
    opentofu_version: "{{ brew_versions.stdout_lines | select('search', '^opentofu ') | first | regex_replace('opentofu\\s+', '') | default('âŒ non installÃ©') }}"
    systemd_version: "{{ brew_versions.stdout_lines | select('search', '^systemd ') | first | regex_replace('systemd\\s+', '') | default('âŒ non installÃ©') }}"
    unzip_version: "{{ brew_versions.stdout_lines | select('search', '^unzip ') | first | regex_replace('unzip\\s+', '') | default('âŒ non installÃ©') }}"
    velero_version: "{{ brew_versions.stdout_lines | select('search', '^velero ') | first | regex_replace('velero\\s+', '') | default('âŒ non installÃ©') }}"
    vim_version: "{{ brew_versions.stdout_lines | select('search', '^vim ') | first | regex_replace('vim\\s+', '') | default('âŒ non installÃ©') }}"
    wget_version: "{{ brew_versions.stdout_lines | select('search', '^wget ') | first | regex_replace('wget\\s+', '') | default('âŒ non installÃ©') }}"
    zellij_version: "{{ brew_versions.stdout_lines | select('search', '^zellij ') | first | regex_replace('zellij\\s+', '') | default('âŒ non installÃ©') }}"
    zsh_version: "{{ brew_versions.stdout_lines | select('search', '^zsh ') | first | regex_replace('zsh\\s+', '') | default('âŒ non installÃ©') }}"
  tags:
    - versions

- name: Set version message as a multi-line string
  set_fact:
    versions_text: |
      ğŸ“¦ Packages installed :
      --------------------------------------------
      ğŸ§ª  Ansible        : {{ ansible_version }}
      ğŸ™  ArgoCD         : {{ argocd_version }}
      â˜ï¸  AWS CLI        : {{ awscli_version }}
      ğŸ“¦  Bat            : {{ bat_version }}
      ğŸ“Š  Btop           : {{ btop_version }}
      ğŸ§¬  Cilium         : {{ cilium_version }}
      ğŸ› ï¸  Crossplane     : {{ crossplane_version }}
      ğŸŒŠ  Curl           : {{ curl_version }}
      ğŸ³  Docker         : {{ docker_version }}
      ğŸ“  Eza            : {{ eza_version }}
      ğŸ¬  Fd             : {{ fd_version }}
      ğŸ   Fzf            : {{ fzf_version }}
      ğŸ™  Git            : {{ git_version }}
      ğŸ›³ï¸  Helm           : {{ helm_version }}
      ğŸ–¥ï¸  K9s            : {{ k9s_version }}
      ğŸ”  Keychain       : {{ keychain_version }}
      ğŸ§±  Kind           : {{ kind_version }}
      ğŸ§©  Krew           : {{ krew_version }}
      ğŸ§ª  Kube Score     : {{ kube_score_version }}
      ğŸ¨  Kubecolor      : {{ kubecolor_version }}
      ğŸ§­  Kubectx        : {{ kubectx_version }}
      ğŸ‹  Kubectl        : {{ kubectl_version }}
      ğŸ§©  Kustomize      : {{ kustomize_version }}
      ğŸ›¡ï¸  Kyverno        : {{ kyverno_version }}
      âœ¨  Neovim         : {{ neovim_version }}
      ğŸŒ  Opentofu       : {{ opentofu_version }}
      ğŸ› ï¸  Systemd        : {{ systemd_version }}
      ğŸ“¦  Unzip          : {{ unzip_version }}
      ğŸ›Ÿ  Velero         : {{ velero_version }}
      ğŸ  Vim            : {{ vim_version }}
      ğŸ›°ï¸  Wget           : {{ wget_version }}
      ğŸ§©  Zellij         : {{ zellij_version }}
      --------------------------------------------
  tags:
    - versions

- name: Print all versions cleanly
  ansible.builtin.debug:
    msg: "{{ versions_text.splitlines() }}"
  tags:
    - versions
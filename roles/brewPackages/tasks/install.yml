---
- name: Disable Homebrew analytics
  ansible.builtin.command:
    cmd: /home/linuxbrew/.linuxbrew/bin/brew analytics off
  register: brew_analytics_result
  changed_when: false

# Install from zplug ?
#- name: Tap olets/tap
#  community.general.homebrew_tap:
#    name: olets/tap
#    state: present

# Check package to install !
- name: Install {{ item }} via Homebrew
  community.general.homebrew:
    name: "{{ item }}"
    state: present
  loop:
    - ansible
    - kubectl
    - argocd
    - docker
    - keychain
    - curl
    - wget
    - git
    - vim
    - systemd
    - bat
    - kube-score
    - fd
    - fzf
    - btop
    - helm
    - kind
    - krew
    - kubectx
    - zellij
    - crossplane
    - awscli
    - zsh
    - kubecolor
    - cilium-cli
    - kustomize
    - kyverno
    - velero
    - eza
    - zplug
    #- zsh-autosuggestions
    #- zsh-autocomplete
    #- olets/tap/zsh-abbr

- name: Get list of installed Homebrew packages with versions
  ansible.builtin.command: brew list --versions
  register: brew_versions
  changed_when: false
  ignore_errors: yes
  tags:
    - list_versions

- name: Parse Homebrew versions for each tool
  set_fact:
    argocd_version: "{{ brew_versions.stdout_lines | select('search', '^argocd ') | first | regex_replace('argocd\\s+', '') | default('âŒ non installÃ©') }}"
    helm_version: "{{ brew_versions.stdout_lines | select('search', '^helm ') | first | regex_replace('helm\\s+', '') | default('âŒ non installÃ©') }}"
    kind_version: "{{ brew_versions.stdout_lines | select('search', '^kind ') | first | regex_replace('kind\\s+', '') | default('âŒ non installÃ©') }}"
    #ansible_version: "{{ brew_versions.stdout_lines | select('search', '^ansible ') | first | regex_replace('^ansible\\s+', '') | regex_replace(\"'([^']+)'\", '\\1') | default('âŒ non installÃ©') }}"
    bat_version: "{{ brew_versions.stdout_lines | select('search', '^bat ') | first | regex_replace('bat\\s+', '') | default('âŒ non installÃ©') }}"
    btop_version: "{{ brew_versions.stdout_lines | select('search', '^btop ') | first | regex_replace('btop\\s+', '') | default('âŒ non installÃ©') }}"
    curl_version: "{{ brew_versions.stdout_lines | select('search', '^curl ') | first | regex_replace('curl\\s+', '') | default('âŒ non installÃ©') }}"
    fd_version: "{{ brew_versions.stdout_lines | select('search', '^fd ') | first | regex_replace('fd\\s+', '') | default('âŒ non installÃ©') }}"
    fzf_version: "{{ brew_versions.stdout_lines | select('search', '^fzf ') | first | regex_replace('fzf\\s+', '') | default('âŒ non installÃ©') }}"
    git_version: "{{ brew_versions.stdout_lines | select('search', '^git ') | first | regex_replace('git\\s+', '') | default('âŒ non installÃ©') }}"
    krew_version: "{{ brew_versions.stdout_lines | select('search', '^krew ') | first | regex_replace('krew\\s+', '') | default('âŒ non installÃ©') }}"
    kubectx_version: "{{ brew_versions.stdout_lines | select('search', '^kubectx ') | first | regex_replace('kubectx\\s+', '') | default('âŒ non installÃ©') }}"
    systemd_version: "{{ brew_versions.stdout_lines | select('search', '^systemd ') | first | regex_replace('systemd\\s+', '') | default('âŒ non installÃ©') }}"
    unzip_version: "{{ brew_versions.stdout_lines | select('search', '^unzip ') | first | regex_replace('unzip\\s+', '') | default('âŒ non installÃ©') }}"
    vim_version: "{{ brew_versions.stdout_lines | select('search', '^vim ') | first | regex_replace('vim\\s+', '') | default('âŒ non installÃ©') }}"
    zellij_version: "{{ brew_versions.stdout_lines | select('search', '^zellij ') | first | regex_replace('zellij\\s+', '') | default('âŒ non installÃ©') }}"
    kubectl_version: "{{ brew_versions.stdout_lines | select('search', '^kubernetes-cli ') | first | regex_replace('kubernetes-cli\\s+', '') | default('âŒ non installÃ©') }}"
  tags:
    - list_versions

- name: Set version message as a multi-line string
  set_fact:
    versions_text: |
      ğŸ“¦ Pacakges installed :
      --------------------------------------------
      ğŸ™  ArgoCD  : {{ argocd_version }}
      ğŸ›³ï¸  Helm    : {{ helm_version }}
      ğŸ§±  Kind    : {{ kind_version }}
      ğŸ“¦  Bat     : {{ bat_version }}
      ğŸ“Š  Btop    : {{ btop_version }}
      ğŸŒŠ  Curl    : {{ curl_version }}
      ğŸ¬  Fd      : {{ fd_version }}
      ğŸ   Fzf     : {{ fzf_version }}
      ğŸ™  Git     : {{ git_version }}
      ğŸ§©  Krew    : {{ krew_version }}
      ğŸ§­  Kubectx : {{ kubectx_version }}
      ğŸ‹  Kubectl : {{ kubectl_version }}
      ğŸ› ï¸  Systemd : {{ systemd_version }}
      ğŸ“¦  Unzip   : {{ unzip_version }}
      ğŸ  Vim     : {{ vim_version }}
      ğŸ§©  Zellij  : {{ zellij_version }}
      --------------------------------------------

- name: Print all versions cleanly
  ansible.builtin.debug:
    msg: "{{ versions_text.splitlines() }}"
  tags:
    - list_versions